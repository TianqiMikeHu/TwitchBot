<html>

<head>
  <title>Twitch Player Embed</title>
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
  <link href="https://fonts.googleapis.com/css2?family=Kalam&amp;display=swap" rel="stylesheet" />
</head>

<body>
  <script>

    var preload = true;
    var url = "";

    window.onload = function () {
      var video = document.getElementById('video');
      video.addEventListener('load', onFrameLoad);
      video.duration = 0;
    }

    function onFrameLoad(event) {
      if (preload) {
        setTimeout(function () {
          preload = false;
          video.src = url;
        }, 1000);
      }
      else {
        video.style = "position:fixed; top:0; left:0; bottom:0; right:0; width:100%; height:100%; border:none; margin:0; padding:0; overflow:hidden; z-index:999999;";
        setTimeout(function () {
          video.style = "position: absolute;width:0;height:0;border:0;";
          preload = true;
        }, event.currentTarget.duration);
      }
    };

    function isOpen(ws) {
      return ws.readyState === ws.OPEN;
    }


    function connectws() {
      let socket = new WebSocket("wss://2bd6aqqafb.execute-api.us-west-2.amazonaws.com/dev");

      let intervalId = window.setInterval(function () {
        if (!isOpen(socket)) return;
        socket.send('ping');
      }, 300000);

      socket.onopen = function (event) {
        const params = new Proxy(new URLSearchParams(window.location.search), {
          get: (searchParams, prop) => searchParams.get(prop),
        });
        let channel = params.channel;

        payload = {
          'route': "sendmessage",
          'action': 'joinchannel',
          'channel': params.channel
        }
        socket.send(JSON.stringify(payload));
      };

      let timers = {};

      function startTimer(timerText, duration, element) {
        var start = Date.now(),
          diff,
          minutes,
          seconds, timerIntervalID;
        function timer() {
          diff = duration - (((Date.now() - start) / 1000) | 0);

          minutes = (diff / 60) | 0;
          seconds = (diff % 60) | 0;

          minutes = minutes < 10 ? "0" + minutes : minutes;
          seconds = seconds < 10 ? "0" + seconds : seconds;

          if (diff <= 0) {
            element.textContent = `${timerText}: DONE`;
            clearInterval(timerIntervalID);
            setTimeout(function () {
              element.remove();
            }, 30000);
          }
          else {
            element.textContent = `${timerText}: ${minutes}:${seconds}`;
          }
        };
        timer();
        timerIntervalID = setInterval(timer, 1000);
      }

      socket.onmessage = function (event) {
        const data = JSON.parse(event.data);
        // console.log(data);
        if (data.action == "newclip") {
          video.duration = data.duration;
          video.src = data.src + "&muted=true";
          url = data.src;
        }
        else if (data.action == "modaction") {
          if (data.category == "text") {
            let element = document.createElement("div");
            element.style = `font-family: 'Kalam', cursive; color: ${data.color}; font-size: ${data.size}px`
            element.textContent = data.content;
            document.getElementById('over').appendChild(element);
          }
          else if (data.category == "timer") {
            let element = document.createElement("div");
            element.style = `font-family: 'Kalam', cursive; color: ${data.color}; font-size: ${data.size}px`
            document.getElementById('over').appendChild(element);
            startTimer(data.content, data.duration, element);
          }
          else if (data.category == "clearAll") {
            document.getElementById('over').textContent = '';
          }
        }
      };

      socket.onclose = function (event) {
        if (event.wasClean) {
          console.log(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
        } else {
          console.log('[close] Connection died');
        }
        clearInterval(intervalId);
        setTimeout(function () {
          connectws();
        }, 1000);
      };

      socket.onerror = function (error) {
        console.log(`[error]`);
      };
    }

    connectws();

  </script>


  <div id="over" style="position: absolute; top: 15px; left: 15px;"></div>
  <iframe id="video" src="" style="position: absolute;width:0;height:0;border:0;" preload="auto">
  </iframe>


</body>

</html>