<!DOCTYPE html>
<html id="html" lang="en">

<head>
    <title>Mike's Mod Interface</title>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Kalam&amp;display=swap" rel="stylesheet" />
</head>

<body style="background-color: black; height: 100vh;">
    <style>
        @keyframes menuAnimation {
            0% {
                transform: translate(-50%, -50%) scale(0.0);
                -webkit-transform: translate(-50%, -50%) scale(0.0);
            }

            100% {
                transform: translate(-50%, -50%) scale(1.0);
                -webkit-transform: translate(-50%, -50%) scale(1.0);
            }
        }

        .dark {
            background-color: #BBBBBB;
        }

        .light {
            background-color: white;
        }
    </style>

    <script>
        var mapping = [];
        var index = 0;

        var left_INT = 0;
        var width_INT = 0;

        var lastClickedElement;
        var editing = false;


        function resize() {
            let video = document.getElementById('video');
            let html = document.getElementById('html');
            let sidebar = document.getElementById('sidebar');
            video.style.height = `${window.innerHeight}px`;

            width_INT = (window.innerHeight / 9.0 * 16.0 | 0);
            video.style.width = `${width_INT}px`;

            left_INT = html.clientWidth - width_INT;
            video.style.left = `${left_INT}px`;

            sidebar.style.height = video.style.height;
            sidebar.style.width = video.style.left;
        }
        window.onload = function () {
            document.body.style.overflow = 'hidden';
            resize();
            let newButton = document.getElementById("newButton");
            newButton.addEventListener("click", create);

            let editButton = document.getElementById("editButton");
            editButton.addEventListener("click", edit);

            let saveButton = document.getElementById("saveButton");
            saveButton.addEventListener("click", save);

            video.src = "https://player.twitch.tv/?channel=mike_hu_0_0&parent=apoorlywrittenbot.cc&allowfullscreen=false&muted=true&autoplay=true&controls=false";
        }
        window.onresize = function () {
            resize();
        }


        var dragging = function () {
            return {
                move: function (divid, xpos, ypos) {
                    divid.style.left = xpos + 'px';
                    divid.style.top = ypos + 'px';
                },
                startMoving: function (divid, container, evt) {
                    evt = evt || window.event;
                    let rect = divid.getBoundingClientRect();
                    let video = document.getElementById(container);
                    var posX = evt.clientX,
                        posY = evt.clientY,
                        divTop = divid.style.top,
                        divLeft = divid.style.left,
                        eWi = parseInt(rect.width),
                        eHe = parseInt(rect.height),
                        cL = parseInt(video.style.left),
                        cWi = parseInt(video.style.width),
                        cHe = parseInt(video.style.height);
                    document.getElementById(container).style.cursor = 'move';
                    divTop = divTop.replace('px', '');
                    divLeft = divLeft.replace('px', '');
                    var diffX = posX - divLeft,
                        diffY = posY - divTop;

                    document.onmousemove = function (evt) {
                        evt = evt || window.event;
                        var posX = evt.clientX,
                            posY = evt.clientY,
                            aX = posX - diffX,
                            aY = posY - diffY;
                        if (aX < cL) aX = cL;
                        if (aY < 0) aY = 0;
                        if (aX + eWi > (cL + cWi)) aX = cL + cWi - eWi;
                        if (aY + eHe > cHe) aY = cHe - eHe;
                        dragging.move(divid, aX, aY);
                    }
                },
                stopMoving: function (container) {
                    document.getElementById(container).style.cursor = 'default';
                    document.onmousemove = function () { }
                },
            }
        }();

        function elementUnfocused() {
            if (lastClickedElement != null) {
                lastClickedElement.style.border = '2px solid transparent';
            }
            let editButton = document.getElementById("editButton");
            editButton.disabled = true;
            editButton.style.background = "#d9d9d9";
        }

        document.onkeydown = function (evt) {
            if (editing) {
                return;
            }
            evt = evt || window.event;
            var isEscape = false;
            if ("key" in evt) {
                isEscape = (evt.key === "Escape" || evt.key === "Esc");
            } else {
                isEscape = (evt.keyCode === 27);
            }
            if (isEscape) {
                elementUnfocused();
            }
        };

        function elementFocused(e) {
            //Unfocus last element
            if (lastClickedElement != null) {
                lastClickedElement.style.border = '2px solid transparent';
            }

            this.style.border = '2px solid #ff6600';
            lastClickedElement = this;

            let editButton = document.getElementById("editButton");
            editButton.disabled = false;
            editButton.style.background = "#6441a5";
        }

        function htmlToElement(html) {
            var template = document.createElement('template');
            html = html.trim();
            template.innerHTML = html;
            return template.content.firstChild;
        }

        function create(e) {
            e.stopPropagation();
            if (editing) {
                return;
            }
            let divString = `<div id="${index.toString()}" 
            style="position: absolute; top: ${window.innerHeight / 2}px; left: ${left_INT + width_INT / 2}px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -o-user-select: none;
            -ms-user-select: none;
            -khtml-user-select: none;
            user-select: none;" 
            onmousedown="dragging.startMoving(this, 'video', event);" 
            onmouseup="dragging.stopMoving('video');"></div>`;
            let element = htmlToElement(divString);
            element.style.border = '2px solid #ff6600';
            element.addEventListener("click", elementFocused);

            index += 1;
            document.getElementById('canvas').appendChild(element);

            // Autofocus on new element
            if (lastClickedElement != null) {
                lastClickedElement.style.border = '2px solid transparent';
            }
            lastClickedElement = element;
            let editButton = document.getElementById("editButton");
            editButton.disabled = false;
            editButton.style.background = "#6441a5";

            let subelement = document.createElement("div");
            subelement.style = `color: #FFFFFF; font-size: ${window.innerHeight / 20}px;`;
            subelement.textContent = "PLACEHOLDER";
            document.getElementById(element.id).appendChild(subelement);

            element_json = {
                top: window.innerHeight / 2,
                left: left_INT + width_INT / 2,
                elements: [
                    {
                        category: 'text',
                        content: 'PLACEHOLDER',
                        color: 'FFFFFF',
                        size: `${window.innerHeight / 20}`
                    }
                ]
            };
            mapping.push(element_json);
        }

        function edit(e) {
            e.stopPropagation();
            if (editing) {
                return;
            }
            editing = true;
            let menu = document.getElementById("menu");
            let mask = document.getElementById("mask");
            mask.style.display = "block";
            menu.style.display = "flex";
            menu.style.animation = "menuAnimation 1s";
        }

        function save(e) {
            e.stopPropagation();
            if (editing) {
                return;
            }
            console.log(mapping);
        }
    </script>

    <div id="menu" class="container" style="font-family: 'Kalam', cursive; display: flex;
        position: absolute; z-index: 10; 
        width: 70%; height: 70%; 
        top: 50%; left:50%; transform: translate(-50%, -50%); 
        background-color: white;">
        <div id="tableHeader" class="container" style="display: flex;
            position: absolute; z-index: 12; 
            width: 100%; height: 10%; 
            top: 0%; left:50%; transform: translate(-50%, 0%); 
            background-color: red;">

        </div>
        <div id="tableBody" class="container" style="display: flex;
            position: absolute; z-index: 11; 
            width: 100%; height: 80%; 
            top: 50%; left:50%; transform: translate(-50%, -50%); overflow: auto;
            background-color: yellow;">

        </div>
    </div>

    <div id="mask" style="position: absolute; z-index: 9; 
    width: 100%; height: 100%; pointer-events: none; opacity: 0.7; background-color: black; display: none"></div>

    <div id="sidebar" class="d-grid"
        style="position: absolute; top: 0px; left: 0px; z-index: 2; font-family: 'Kalam', cursive;">
        <button type="button" id="helpButton" class="btn btn-primary rounded-0" style="background-color: #6441a5;"
            onmouseover="this.style.background = '#6699ff'"
            onmouseleave="this.style.background = '#6441a5'">Help</button>

        <button type="button" id="newButton" class="btn btn-primary rounded-0" style="background-color: #6441a5;"
            onmouseover="this.style.background = '#ffe066'" onmouseleave="this.style.background = '#6441a5'">New
            Element</button>

        <button disabled type="button" id="editButton" class="btn btn-primary rounded-0"
            style="background-color: #d9d9d9;" onmouseover="if(!this.disabled){this.style.background = '#ff9966';}"
            onmouseleave="if(this.disabled){this.style.background = '#d9d9d9'}else{this.style.background = '#6441a5'}">Edit
            This Element</button>

        <button type="button" id="saveButton" class="btn btn-primary rounded-0" style="background-color: #6441a5;"
            onmouseover="this.style.background = '#99ff99'"
            onmouseleave="this.style.background = '#6441a5'">Save</button>

        <button type="button" id="clearButton" class="btn btn-primary rounded-0" style="background-color: #6441a5;"
            onmouseover="this.style.background = '#ff6666'" onmouseleave="this.style.background = '#6441a5'">Clear
            All</button>
    </div>

    <iframe id="video" src="" style="position: absolute; top: 0px; pointer-events: none; border: none; z-index: 0;"
        preload="auto"></iframe>

    <div id="canvas" style="font-family: 'Kalam', cursive; position: absolute; z-index: 1;">
    </div>
</body>

</html>