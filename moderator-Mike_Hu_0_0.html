<!DOCTYPE html>
<html id="html" lang="en">

<head>
    <title>Mike's Mod Interface</title>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Kalam&amp;display=swap" rel="stylesheet" />
</head>

<body style="background-color: black; height: 100vh;">
    <style>
        @keyframes menuAnimation {
            0% {
                transform: translate(-50%, -50%) scale(0.0);
                -webkit-transform: translate(-50%, -50%) scale(0.0);
            }

            100% {
                transform: translate(-50%, -50%) scale(1.0);
                -webkit-transform: translate(-50%, -50%) scale(1.0);
            }
        }

        @keyframes menuAnimationReversed {
            0% {
                transform: translate(-50%, -50%) scale(1.0);
                -webkit-transform: translate(-50%, -50%) scale(1.0);
                opacity: 1.0;
            }

            100% {
                transform: translate(-50%, 0%) scale(1.0);
                -webkit-transform: translate(-50%, 0%) scale(1.0);
                opacity: 0.0;
            }
        }

        .wordsColumn {
            width: 40%;
            height: 100%;
            display: inline-block;
            background-color: #a1e4ff;
            position: absolute;
            left: 0%;
        }

        .typeColumn {
            width: 12%;
            height: 100%;
            display: inline-block;
            background-color: #99e2ff;
            position: absolute;
            left: 40%;
        }

        .colorColumn {
            width: 14%;
            height: 100%;
            display: inline-block;
            background-color: #80dbff;
            position: absolute;
            left: 52%;
        }

        .sizeColumn {
            width: 13%;
            height: 100%;
            display: inline-block;
            background-color: #66d4ff;
            position: absolute;
            left: 66%;
        }

        .timeColumn {
            width: 13%;
            height: 100%;
            display: inline-block;
            background-color: #4dccff;
            position: absolute;
            left: 79%;
        }

        .restartColumn {
            width: 8%;
            height: 100%;
            display: inline-block;
            background-color: #33c5ff;
            position: absolute;
            left: 92%;
        }
    </style>

    <script>
        var mapping = {};
        var index = 0;
        const font_scale = 25;

        var left_INT = 0;
        var width_INT = 0;

        var lastClickedElement;
        var editing = false;

        var validationDictionary = {};
        const patterns = {
            nonEmpty: /^(?!\s*$).+/,
            hex: /^[0-9A-F]{6}$/i,
            positiveInteger: /^[1-9]\d*$/,
            positiveFloat: /^(?=.+)(?:[1-9]\d*|0)?(?:\.\d+)?$/
        }


        function resize() {
            let video = document.getElementById('video');
            let html = document.getElementById('html');
            let sidebar = document.getElementById('sidebar');
            video.style.height = `${window.innerHeight}px`;

            width_INT = (window.innerHeight / 9.0 * 16.0 | 0);
            video.style.width = `${width_INT}px`;

            left_INT = html.clientWidth - width_INT;
            video.style.left = `${left_INT}px`;

            sidebar.style.height = video.style.height;
            sidebar.style.width = video.style.left;
        }
        window.onload = function () {
            document.body.style.overflow = 'hidden';
            resize();
            let newButton = document.getElementById("newButton");
            newButton.addEventListener("click", create);

            let editButton = document.getElementById("editButton");
            editButton.addEventListener("click", edit);

            let saveButton = document.getElementById("saveButton");
            saveButton.addEventListener("click", save);

            let clearButton = document.getElementById("clearButton");
            clearButton.addEventListener("click", clearAll);

            video.src = "https://player.twitch.tv/?channel=mike_hu_0_0&parent=apoorlywrittenbot.cc&allowfullscreen=false&muted=true&autoplay=true&controls=false";
        }
        window.onresize = function () {
            resize();
        }


        var dragging = function () {
            return {
                move: function (divid, xpos, ypos) {
                    divid.style.left = xpos + 'px';
                    divid.style.top = ypos + 'px';
                },
                startMoving: function (divid, container, evt) {
                    evt = evt || window.event;
                    let rect = divid.getBoundingClientRect();
                    let video = document.getElementById(container);
                    var posX = evt.clientX,
                        posY = evt.clientY,
                        divTop = divid.style.top,
                        divLeft = divid.style.left,
                        eWi = parseInt(rect.width),
                        eHe = parseInt(rect.height),
                        cL = parseInt(video.style.left),
                        cWi = parseInt(video.style.width),
                        cHe = parseInt(video.style.height);
                    document.getElementById(container).style.cursor = 'move';
                    divTop = divTop.replace('px', '');
                    divLeft = divLeft.replace('px', '');
                    var diffX = posX - divLeft,
                        diffY = posY - divTop;

                    document.onmousemove = function (evt) {
                        evt = evt || window.event;
                        var posX = evt.clientX,
                            posY = evt.clientY,
                            aX = posX - diffX,
                            aY = posY - diffY;
                        if (aX < cL) aX = cL;
                        if (aY < 0) aY = 0;
                        if (aX + eWi > (cL + cWi)) aX = cL + cWi - eWi;
                        if (aY + eHe > cHe) aY = cHe - eHe;
                        dragging.move(divid, aX, aY);
                    }
                },
                stopMoving: function (divid, container) {
                    let video = document.getElementById(container);
                    video.style.cursor = 'default';
                    mapping[divid.id]["top"] = parseFloat(divid.style.top) * 100.0 / window.innerHeight;
                    mapping[divid.id]["left"] = (parseFloat(divid.style.left) - parseFloat(video.style.left)) * 100.0 / parseFloat(video.style.width);
                    document.onmousemove = function () { }
                },
            }
        }();

        function elementUnfocused() {
            if (lastClickedElement != null) {
                lastClickedElement.style.border = '2px solid transparent';
            }
            let editButton = document.getElementById("editButton");
            editButton.disabled = true;
            editButton.style.background = "#d9d9d9";
        }

        document.onkeydown = function (evt) {
            if (editing) {
                return;
            }
            evt = evt || window.event;
            var isEscape = false;
            if ("key" in evt) {
                isEscape = (evt.key === "Escape" || evt.key === "Esc");
            } else {
                isEscape = (evt.keyCode === 27);
            }
            if (isEscape) {
                elementUnfocused();
            }
        };

        function elementFocused(e) {
            //Unfocus last element
            if (lastClickedElement != null) {
                lastClickedElement.style.border = '2px solid transparent';
            }

            this.style.border = '2px solid #ff6600';
            lastClickedElement = this;

            let editButton = document.getElementById("editButton");
            editButton.disabled = false;
            editButton.style.background = "#6441a5";
        }

        function htmlToElement(html) {
            var template = document.createElement('template');
            html = html.trim();
            template.innerHTML = html;
            return template.content.firstChild;
        }

        function create(e) {
            e.stopPropagation();
            if (editing) {
                return;
            }
            let divString = `<div id="${index.toString()}" 
            style="position: absolute; top: ${window.innerHeight / 2}px; left: ${left_INT + width_INT / 2}px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -o-user-select: none;
            -ms-user-select: none;
            -khtml-user-select: none;
            user-select: none;" 
            onmousedown="dragging.startMoving(this, 'video', event);" 
            onmouseup="dragging.stopMoving(this, 'video');"></div>`;
            let element = htmlToElement(divString);
            element.style.border = '2px solid #ff6600';
            element.addEventListener("click", elementFocused);

            index += 1;
            document.getElementById('canvas').appendChild(element);

            // Autofocus on new element
            if (lastClickedElement != null) {
                lastClickedElement.style.border = '2px solid transparent';
            }
            lastClickedElement = element;
            let editButton = document.getElementById("editButton");
            editButton.disabled = false;
            editButton.style.background = "#6441a5";

            let subelement = document.createElement("div");
            subelement.style = `color: #FFFFFF; font-size: ${window.innerHeight / font_scale}px;`;
            subelement.textContent = "PLACEHOLDER";
            document.getElementById(element.id).appendChild(subelement);

            element_json = {
                top: 50,
                left: 50,
                elements: [
                    {
                        category: 'text',
                        content: 'PLACEHOLDER',
                        color: 'FFFFFF',
                        size: `${window.innerHeight / font_scale}`
                    }
                ]
            };
            mapping[element.id] = element_json;

            //     mapping  = {"0": {
            //      top: 50,
            //      left: 20,
            //      elements: [
            //          {
            //              category: 'timer',
            //              content: 'Banned Word',
            //              expiration: 1682833639,
            //              active: true,
            //              color: 'FFAAFF',
            //              size: '35'
            //          }
            //      ]
            //  }};
        }

        function selectTrigger(select) {
            let type = select.value;
            let id = (select.id).substring(6);
            let time = document.getElementById(`time${id}`);
            let restart = document.getElementById(`restart${id}`);
            if (type == "Timer") {
                time.disabled = false;
                time.value = "";
                time.style.color = "black";
                restart.disabled = true;
                restart.checked = true;
                validationDictionary[`time${id}`] = false;
                time.classList.add("is-invalid");
            }
            else {
                time.disabled = true;
                time.value = "-";
                time.style.color = "black";
                restart.disabled = true;
                restart.checked = false;
                validationDictionary[`time${id}`] = true;
                time.classList.remove("is-invalid");
            }
        }

        function checkboxTrigger(checkbox) {
            let id = (checkbox.id).substring(7);
            let time = document.getElementById(`time${id}`);
            if (checkbox.checked) {
                time.value = "";
                time.style.color = "black";
                time.disabled = false;
                validationDictionary[`time${id}`] = false;
                time.classList.add("is-invalid");
            }
            else {
                time.value = "ACTIVE";
                time.style.color = "red";
                time.disabled = true;
                validationDictionary[`time${id}`] = true;
                time.classList.remove("is-invalid");
            }
        }

        const alert = (message, type) => {
            const wrapper = document.createElement('div')
            wrapper.innerHTML = [
                `<div class="alert alert-${type} alert-dismissible" role="alert" style="z-index:99;">`,
                `   <div>${message}</div>`,
                '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
                '</div>'
            ].join('');

            let alertPlaceholder = document.getElementById('liveAlertPlaceholder');
            alertPlaceholder.append(wrapper);
        }

        function validateInput(input, pattern) {
            if (patterns[pattern].test(input.value)) {
                input.classList.remove("is-invalid");
                validationDictionary[input.id] = true;
            } else {
                input.classList.add("is-invalid");
                validationDictionary[input.id] = false;
            }
        }

        function edit(e) {
            e.stopPropagation();
            if (editing) {
                return;
            }
            editing = true;
            let menu = document.getElementById("menu");
            let mask = document.getElementById("mask");
            let tableBody = document.getElementById("tableBody");
            let canvas = document.getElementById("canvas");
            canvas.style.pointerEvents = "none";
            tableBody.textContent = '';
            validationDictionary = {};

            let element_json = mapping[lastClickedElement.id];

            let index = 0;

            for (const ele of element_json.elements) {
                let size_INT = parseFloat(ele.size);
                size_INT = size_INT * 100.0 / (window.innerHeight / font_scale);

                let timeString = "-";
                if (ele.expiration) {
                    if (ele.active) {
                        timeString = "ACTIVE";
                    }
                    else {
                        timeString = `${ele.expiration}`;
                    }
                }

                let divString = `<div class="tableRow mb-2" style="height: 12%">
                <div class="wordsColumn d-flex justify-content-center" style="height: 12%;">
                    <input type="text" class="form-control needs-validation rounded-0" id="words${index}" placeholder="PLACEHOLDER" value="${ele.content}"
                    onkeyup="validateInput(this, 'nonEmpty');">
                </div>
                <div class="typeColumn d-flex justify-content-center" style="height: 12%;">
                    <select class="form-select rounded-0" id="select${index}" onchange="selectTrigger(this);">
                        <option ${ele.category == 'text' ? 'selected' : ''} value="Text">Text</option>
                        <option ${ele.category == 'timer' ? 'selected' : ''} value="Timer">Timer</option>
                        <option value="DELETE">DELETE</option>
                      </select>
                </div>
                <div class="colorColumn d-flex justify-content-center" style="height: 12%;">
                    <div class="input-group">
                        <span class="input-group-text rounded-0" id="color${index}Prepend">#</span>
                        <input type="text" class="form-control needs-validation rounded-0" id="color${index}"
                            aria-describedby="color${index}Prepend" placeholder="FFFFFF" value="${ele.color}"
                            onkeyup="validateInput(this, 'hex');">
                    </div>
                </div>
                <div class="sizeColumn d-flex justify-content-center" style="height: 12%;">
                    <div class="input-group">
                        <input type="text" class="form-control needs-validation rounded-0" id="size${index}"
                            aria-describedby="size${index}Postpend" placeholder="100" value="${size_INT}"
                            onkeyup="validateInput(this, 'positiveFloat');">
                        <span class="input-group-text rounded-0" id="size${index}Postpend">%</span>
                    </div>
                </div>
                <div class="timeColumn d-flex justify-content-center" style="height: 12%;">
                    <div class="input-group">
                        <input type="text" class="form-control needs-validation rounded-0" id="time${index}"
                            aria-describedby="time${index}Postpend" style="color:${ele.active ? 'red' : 'black'}"
                            placeholder="300" value=${timeString} ${ele.category == 'timer' && ele.active == false ? '' : 'disabled'}
                            onkeyup="validateInput(this, 'positiveInteger');">
                        <span class="input-group-text rounded-0" id="time${index}Postpend">s</span>
                    </div>
                </div>
                <div class="restartColumn d-flex align-items-center justify-content-center" style="height: 12%; background-color: white;">
                    <input type="checkbox" class="form-check-input form-control needs-validation rounded-0" id="restart${index}" 
                        style="width: 100%; height: 100%; margin: 0px;" onchange="checkboxTrigger(this);"
                        ${ele.category == 'timer' && ele.active ? '' : 'disabled'} ${ele.category == 'timer' && ele.active == false ? 'checked' : ''}>
                </div>
            </div>`;


                let tableRow = htmlToElement(divString);
                tableBody.appendChild(tableRow);
                validationDictionary[`words${index}`] = true;
                validationDictionary[`color${index}`] = true;
                validationDictionary[`size${index}`] = true;
                validationDictionary[`time${index}`] = true;
                index += 1;
            }

            mask.style.display = "block";
            menu.style.display = "flex";
            menu.style.animation = "menuAnimation 0.5s";
        }

        function subelement(e) {
            e.stopPropagation();
            let tableBody = document.getElementById("tableBody");
            let index = tableBody.childElementCount;

            let divString = `<div class="tableRow mb-2" style="height: 12%">
                <div class="wordsColumn d-flex justify-content-center" style="height: 12%;">
                    <input type="text" class="form-control needs-validation rounded-0 is-invalid" id="words${index}" placeholder="PLACEHOLDER"
                    onkeyup="validateInput(this, 'nonEmpty');">
                </div>
                <div class="typeColumn d-flex justify-content-center" style="height: 12%;">
                    <select class="form-select rounded-0" id="select${index}" onchange="selectTrigger(this);">
                        <option selected value="Text">Text</option>
                        <option value="Timer">Timer</option>
                        <option value="DELETE">DELETE</option>
                      </select>
                </div>
                <div class="colorColumn d-flex justify-content-center" style="height: 12%;">
                    <div class="input-group">
                        <span class="input-group-text rounded-0" id="color${index}Prepend">#</span>
                        <input type="text" class="form-control needs-validation rounded-0" id="color${index}"
                            aria-describedby="color${index}Prepend" placeholder="FFFFFF" value="FFFFFF"
                            onkeyup="validateInput(this, 'hex');">
                    </div>
                </div>
                <div class="sizeColumn d-flex justify-content-center" style="height: 12%;">
                    <div class="input-group">
                        <input type="text" class="form-control needs-validation rounded-0" id="size${index}"
                            aria-describedby="size${index}Postpend" placeholder="100" value="100"
                            onkeyup="validateInput(this, 'positiveFloat');">
                        <span class="input-group-text rounded-0" id="size${index}Postpend">%</span>
                    </div>
                </div>
                <div class="timeColumn d-flex justify-content-center" style="height: 12%;">
                    <div class="input-group">
                        <input type="text" class="form-control needs-validation rounded-0" id="time${index}"
                            aria-describedby="time${index}Postpend" style="color:black"
                            placeholder="300" value="-" disabled
                            onkeyup="validateInput(this, 'positiveInteger');">
                        <span class="input-group-text rounded-0" id="time${index}Postpend">s</span>
                    </div>
                </div>
                <div class="restartColumn d-flex align-items-center justify-content-center" style="height: 12%; background-color: white;">
                    <input type="checkbox" class="form-check-input form-control needs-validation rounded-0" id="restart${index}" 
                        style="width: 100%; height: 100%; margin: 0px;" onchange="checkboxTrigger(this);"
                        disabled>
                </div>
            </div>`;

            let tableRow = htmlToElement(divString);
            tableBody.appendChild(tableRow);
            validationDictionary[`words${index}`] = false;
            validationDictionary[`color${index}`] = true;
            validationDictionary[`size${index}`] = true;
            validationDictionary[`time${index}`] = true;
        }

        function closemenu(e) {
            e.stopPropagation();
            for (const [key, value] of Object.entries(validationDictionary)) {
                if(!value){
                    alert("Please fix the invalid value(s)", "warning");
                    console.log(validationDictionary);
                    return;
                }
            }
            let menu = document.getElementById("menu");
            let mask = document.getElementById("mask");
            let canvas = document.getElementById("canvas");
            canvas.style.pointerEvents = "auto";
            menu.style.animation = "menuAnimationReversed 0.2s";
            mask.style.display = "none";
            alert("Successfully validated all input values", "success");
            setTimeout(() => {
                menu.style.display = "none";
                editing = false;
            }, 200);
        }

        function save(e) {
            e.stopPropagation();
            if (editing) {
                return;
            }
            console.log(mapping);
        }

        function clearAll(e) {
            e.stopPropagation();
            if (editing) {
                return;
            }
            mapping = {};
            document.getElementById("canvas").textContent = '';
        }
    </script>

    <div id="liveAlertPlaceholder" style="position:fixed; top: 0px; width: 100%; z-index: 100;"></div>
    <div id="menu" class="container" style="font-family: 'Kalam', cursive; display: none;
        position: absolute; z-index: 10; 
        width: 75%; height: 70%; 
        top: 50%; left:50%; transform: translate(-50%, -50%); 
        background-color: white;">
        <div id="tableHeader" class="container pe-1" style="
            position: absolute; z-index: 11; 
            width: 100%; height: 10%; 
            top: 0%; left:50%; transform: translate(-50%, 0%);">
            <div class="wordsColumn d-flex align-items-center justify-content-center">
                Words
            </div>
            <div class="typeColumn d-flex align-items-center justify-content-center">
                Type
            </div>
            <div class="colorColumn d-flex align-items-center justify-content-center">
                Font Color
            </div>
            <div class="sizeColumn d-flex align-items-center justify-content-center">
                Font Size
            </div>
            <div class="timeColumn d-flex align-items-center justify-content-center">
                Time
            </div>
            <div class="restartColumn d-flex align-items-center justify-content-center">
                Restart?
            </div>
        </div>
        <div id="tableBody" class="container" style="
            position: absolute; z-index: 11; 
            width: 100%; height: 80%; 
            top: 50%; left:50%; transform: translate(-50%, -50%); overflow: auto; overflow-y: overlay;">

        </div>
        <div id="tableFooter" class="container" style="
            position: absolute; z-index: 12; 
            width: 100%; height: 10%; 
            top: 90%; left:50%; transform: translate(-50%, 0%);">
            <button type="button" class="btn btn-primary mb-1 ms-1" onclick="subelement(event);"
                style="display: inline-block; position: absolute; left: 0%; height: 90%;">Add Sub-Element</button>

            <button type="button" class="btn btn-success mb-1 me-1" onclick="closemenu(event);"
                style="display: inline-block; position: absolute; right: 0%; height: 90%;">Close Menu</button>
        </div>
    </div>

    <div id="mask" style="position: absolute; z-index: 9; 
    width: 100%; height: 100%; pointer-events: none; opacity: 0.7; background-color: black; display: none"></div>

    <div id="sidebar" class="d-grid"
        style="position: absolute; top: 0px; left: 0px; z-index: 2; font-family: 'Kalam', cursive;">
        <button type="button" id="helpButton" class="btn btn-primary rounded-0" style="background-color: #6441a5;"
            onmouseover="this.style.background = '#6699ff'"
            onmouseleave="this.style.background = '#6441a5'">Help</button>

        <button type="button" id="newButton" class="btn btn-primary rounded-0" style="background-color: #6441a5;"
            onmouseover="this.style.background = '#ffe066'" onmouseleave="this.style.background = '#6441a5'">New
            Element</button>

        <button disabled type="button" id="editButton" class="btn btn-primary rounded-0"
            style="background-color: #d9d9d9;" onmouseover="if(!this.disabled){this.style.background = '#ff9966';}"
            onmouseleave="if(this.disabled){this.style.background = '#d9d9d9'}else{this.style.background = '#6441a5'}">Edit
            This Element</button>

        <button type="button" id="saveButton" class="btn btn-primary rounded-0" style="background-color: #6441a5;"
            onmouseover="this.style.background = '#99ff99'"
            onmouseleave="this.style.background = '#6441a5'">Save</button>

        <button type="button" id="clearButton" class="btn btn-primary rounded-0" style="background-color: #6441a5;"
            onmouseover="this.style.background = '#ff6666'" onmouseleave="this.style.background = '#6441a5'">Clear
            All</button>
    </div>

    <iframe id="video" src="" style="position: absolute; top: 0px; pointer-events: none; border: none; z-index: 0;"
        preload="auto"></iframe>

    <div id="canvas" style="font-family: 'Kalam', cursive; position: absolute; z-index: 1;">
    </div>
</body>

</html>